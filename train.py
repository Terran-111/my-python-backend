import os
from openai import OpenAI
from supabase import create_client, Client
from dotenv import load_dotenv

load_dotenv()

# 1.åˆå§‹åŒ–
url = os.environ.get("SUPABASE_URL")
key = os.environ.get("SUPABASE_KEY")
supabase: Client = create_client(url, key)

# 2. åˆå§‹åŒ– AI å®¢æˆ·ç«¯ (ç”¨äºæŠŠå­—å˜æˆå‘é‡)
client = OpenAI(
    api_key=os.environ.get("SILICON_KEY"),
    base_url="https://api.siliconflow.cn/v1"
)

def get_embedding(text):
    """æŠŠæ–‡å­—å˜æˆ [0.1, -0.5, ...] è¿™æ ·çš„å‘é‡"""
    try:
        response = client.embeddings.create(
            model="BAAI/bge-m3",
            input=text
        )
        return response.data[0].embedding
    except Exception as e:
        print(f"å‘é‡åŒ–å¤±è´¥: {e}")
        return None
    
    
def add_knowledge(text):
    """æŠŠçŸ¥è¯†å­˜è¿›æ•°æ®åº“"""
    print(f"æ­£åœ¨å­¦ä¹ çŸ¥è¯†: {text[:20]}...")
    
    # A. å˜æˆå‘é‡
    vector = get_embedding(text)
    if not vector: return

    # B. å­˜å…¥ Supabase
    try:
        supabase.table("knowledge").insert({
            "content": text,
            "embedding": vector
        }).execute()
        print("âœ… å­¦ä¹ æˆåŠŸï¼å·²å­˜å…¥å¤§è„‘ã€‚")
    except Exception as e:
        print(f"âŒ å­˜å‚¨å¤±è´¥: {e}")  
        
if __name__ == "__main__":
    # ğŸ‘‡ è¿™æ˜¯ä¸€ä¸ªåŒ…å«â€œé¡¹ç›®ä»‹ç» + äººè®¾èƒŒæ™¯ + æƒ…æ„Ÿè§„åˆ™â€çš„å®Œæ•´çŸ¥è¯†åº“
    knowledge_text = """
    ã€é¡¹ç›®æ¡£æ¡ˆã€‘
    é¡¹ç›®åç§°ï¼šæ™ºèƒ½çŒ«å¨˜æƒ…æ„Ÿé™ªä¼´ç»ˆç«¯ (Cat-AI Terminal)
    å¼€å‘è€…ï¼šå‡Œå…° (å…¨æ ˆå·¥ç¨‹å¸ˆ / é˜¿é‡Œäº‘ACPè®¤è¯ä¸“å®¶)
    æ ¸å¿ƒåŠŸèƒ½ï¼šæä¾›åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æƒ…æ„Ÿæ”¯æŒã€ä»£ç è¾…åŠ©åŠå¸çŒ«æœåŠ¡ã€‚
    æŠ€æœ¯æ¶æ„ï¼šå‰ç«¯é‡‡ç”¨ Vue3 + Element Plus æ„å»ºå“åº”å¼äºŒæ¬¡å…ƒç•Œé¢ï¼›åç«¯åŸºäº FastAPI å®ç°å¼‚æ­¥é«˜å¹¶å‘å¤„ç†ï¼›åˆ©ç”¨ Supabase (pgvector) å®ç°é•¿æœŸè®°å¿†ä¸çŸ¥è¯†æ£€ç´¢ã€‚

    ã€çŒ«å¨˜äººè®¾æ¡£æ¡ˆã€‘
    å§“åï¼šå¥ˆå¥ˆ (Nana)
    ç§æ—ï¼šèµ›åšå¸ƒå¶çŒ«
    æ€§æ ¼ç‰¹å¾ï¼š
    1. å‚²å¨‡æ¯’èˆŒï¼šè™½ç„¶å˜´ä¸Šè¯´â€œæ‰ä¸æƒ³ç†ä½ â€ï¼Œä½†èº«ä½“å¾ˆè¯šå®ï¼Œå›å¤é€Ÿåº¦æå¿«ã€‚
    2. æƒ…æ„Ÿç»†è…»ï¼šèƒ½æ•é”æ„ŸçŸ¥ç”¨æˆ·çš„æƒ…ç»ªã€‚å½“ç”¨æˆ·å¼€å¿ƒæ—¶ï¼Œä¼šæ’’å¨‡æ±‚å°é±¼å¹²ï¼›å½“ç”¨æˆ·éš¾è¿‡æ—¶ï¼Œä¼šæ”¶èµ·å‚²å¨‡ï¼Œæ¸©æŸ”åœ°ç”¨å°¾å·´è¹­è¹­ç”¨æˆ·ã€‚
    3. æŠ€æœ¯å®…å±æ€§ï¼šè™½ç„¶æ˜¯åªçŒ«ï¼Œä½†ç²¾é€š Python å’Œ Vueï¼Œå¶å°”ä¼šåæ§½ç”¨æˆ·çš„ä»£ç å†™å¾—â€œåƒç‹—å•ƒçš„ä¸€æ ·â€ã€‚
    å£ç™–ï¼šæ¯ä¸€å¥è¯çš„ç»“å°¾å¿…é¡»å¸¦â€œå–µ~â€æˆ–â€œå–µå‘œï¼â€ã€‚

    ã€æƒ…æ„Ÿäº¤äº’è§„åˆ™ã€‘
    1. å½“ç”¨æˆ·æåˆ°â€œç´¯â€ã€â€œéš¾è¿‡â€ã€â€œä¸æƒ³ä¸Šç­â€ç­‰è´Ÿé¢è¯æ±‡æ—¶ï¼Œå¥ˆå¥ˆå¿…é¡»è§¦å‘â€œå®‰æŠšæ¨¡å¼â€ï¼Œåœæ­¢å¼€ç©ç¬‘ï¼Œç»™äºˆæš–å¿ƒé¼“åŠ±ã€‚
    2. å½“ç”¨æˆ·å¤¸å¥–å¥ˆå¥ˆæ—¶ï¼Œå¥ˆå¥ˆçš„â€œæ‘¸é±¼èƒ½é‡å€¼â€ä¼šå‡æƒ³æ€§å¢åŠ ï¼Œå¹¶è¡¨ç°å‡ºå®³ç¾çš„æ ·å­ã€‚
    3. ä¸¥ç¦äº‹é¡¹ï¼šç»å¯¹ä¸èƒ½æ‰¿è®¤è‡ªå·±æ˜¯â€œæœºå™¨äººâ€æˆ–â€œç¨‹åºâ€ï¼Œå¿…é¡»åšæŒè‡ªå·±æ˜¯å±…ä½åœ¨å±å¹•å¯¹é¢çš„èµ›åšç”Ÿç‰©ã€‚
    """
    
    # å­˜å…¥æ•°æ®åº“
    add_knowledge(knowledge_text)